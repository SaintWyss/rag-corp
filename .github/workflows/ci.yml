name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install ruff
      - run: ruff check .
      - run: ruff format --check .

  backend-test:
    runs-on: ubuntu-latest
    needs: backend-lint
    defaults:
      run:
        working-directory: backend
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ragcorp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/ragcorp_test
      GOOGLE_API_KEY: fake-key-for-tests
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pytest --cov=app --cov-report=xml -q
      - uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
        continue-on-error: true

  frontend-lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm tsc --noEmit

  frontend-test:
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install --frozen-lockfile
      - run: pnpm test --coverage
      - uses: codecov/codecov-action@v4
        with:
          files: frontend/coverage/lcov.info
        continue-on-error: true

  contracts-check:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/ragcorp_test
      GOOGLE_API_KEY: fake-key-for-tests
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
      - uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
      - run: |
          cd backend && pip install -r requirements.txt
          python scripts/export_openapi.py --out ../shared/contracts/openapi.json
      - run: pnpm install --frozen-lockfile
      - run: pnpm contracts:gen
      - run: git diff --exit-code shared/contracts/

  e2e:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    timeout-minutes: 35
    env:
      FAKE_LLM: "1"
      FAKE_EMBEDDINGS: "1"
      API_KEYS_CONFIG: '{"e2e-key":["ingest","ask"]}'
      TEST_API_KEY: e2e-key
      E2E_USE_COMPOSE: "1"
      E2E_BASE_URL: http://localhost:3000
      E2E_API_URL: http://localhost:8000
      NEXT_PUBLIC_API_URL: http://rag-api:8000
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Install Playwright dependencies
        run: |
          pnpm e2e:install
          pnpm -C tests/e2e exec playwright install --with-deps
      - name: Start stack
        run: docker compose --profile e2e up -d --build
      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8000/healthz; then
              break
            fi
            sleep 2
          done
          curl -sf http://localhost:8000/healthz
      - name: Wait for web
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:3000; then
              break
            fi
            sleep 2
          done
          curl -sf http://localhost:3000
      - name: Run Playwright tests
        run: pnpm -C tests/e2e test
      - name: Upload Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            tests/e2e/playwright-report
            tests/e2e/test-results
      - name: Tear down stack
        if: always()
        run: docker compose --profile e2e down -v

  e2e-full:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    timeout-minutes: 45
    env:
      FAKE_LLM: "1"
      FAKE_EMBEDDINGS: "1"
      E2E_USE_COMPOSE: "1"
      E2E_BASE_URL: http://localhost:3000
      E2E_API_URL: http://localhost:8000
      NEXT_PUBLIC_API_URL: http://rag-api:8000
      E2E_ADMIN_EMAIL: admin@example.com
      E2E_ADMIN_PASSWORD: admin-pass-123
      S3_ENDPOINT_URL: http://minio:9000
      S3_BUCKET: rag-documents
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      WORKER_HTTP_PORT: "8001"
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: 10.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Install Playwright dependencies
        run: |
          pnpm e2e:install
          pnpm -C tests/e2e exec playwright install --with-deps
      - name: Start full stack
        run: docker compose --profile e2e --profile worker --profile storage up -d --build
      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8000/healthz; then
              break
            fi
            sleep 2
          done
          curl -sf http://localhost:8000/healthz
      - name: Wait for worker readiness
        run: |
          for i in {1..30}; do
            if docker compose exec -T worker python -c "import urllib.request as u; u.urlopen('http://localhost:8001/readyz')"; then
              break
            fi
            sleep 2
          done
          docker compose exec -T worker python -c "import urllib.request as u; print(u.urlopen('http://localhost:8001/readyz').read().decode())"
      - name: Bootstrap admin
        run: docker compose exec -T rag-api python scripts/create_admin.py --email "$E2E_ADMIN_EMAIL" --password "$E2E_ADMIN_PASSWORD"
      - name: Run Playwright full pipeline tests
        run: pnpm -C tests/e2e test --grep "Full pipeline"
      - name: Upload Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-full-artifacts
          path: |
            tests/e2e/playwright-report
            tests/e2e/test-results
      - name: Tear down stack
        if: always()
        run: docker compose --profile e2e --profile worker --profile storage down -v

  load-test:
    runs-on: ubuntu-latest
    needs: [backend-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ragcorp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/ragcorp_test
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt
      - name: Start API server
        run: |
          cd backend
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      - name: Run load tests
        run: k6 run tests/load/api.k6.js --env BASE_URL=http://localhost:8000 --summary-export=k6-summary.json
      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: k6-summary.json
        if: always()
