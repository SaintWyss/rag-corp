# Database Migrations (Alembic)

**Project:** RAG Corp  
**Last Updated:** 2026-01-15

---

## Overview

RAG Corp uses [Alembic](https://alembic.sqlalchemy.org/) for database schema migrations. Migrations allow us to evolve the PostgreSQL schema in a controlled, versioned manner.

**Location:** `backend/alembic/`

```
backend/
├── alembic.ini          # Alembic configuration
└── alembic/
    ├── env.py           # Migration environment
    ├── script.py.mako   # Template for new migrations
    └── versions/        # Migration scripts
        ├── .gitkeep
        └── 001_initial.py
```

---

## Configuration

Alembic reads `DATABASE_URL` from environment variables:

```bash
# Default (local development)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/rag
```

---

## Common Commands

### Check Current Revision

```bash
cd backend
alembic current
```

### View Migration History

```bash
cd backend
alembic history --verbose
```

### Create a New Migration

```bash
cd backend
alembic revision -m "add_column_xyz"
```

This creates a new file in `alembic/versions/` with `upgrade()` and `downgrade()` functions.

### Apply All Pending Migrations

```bash
cd backend
alembic upgrade head
```

Con Docker Compose (canonica):

```bash
pnpm db:migrate
```

### Apply Specific Migration

```bash
cd backend
alembic upgrade <revision_id>
```

### Rollback Last Migration

```bash
cd backend
alembic downgrade -1
```

### Rollback to Specific Revision

```bash
cd backend
alembic downgrade <revision_id>
```

### Rollback All Migrations

```bash
cd backend
alembic downgrade base
```

---

## Writing Migrations

### Migration Template

```python
"""<description>

Revision ID: <auto-generated>
Revises: <previous-revision>
Create Date: <auto-generated>
"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = '<auto-generated>'
down_revision = '<previous-revision>'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Add your upgrade operations here
    op.add_column('table_name', sa.Column('new_column', sa.String(255)))


def downgrade() -> None:
    # Add your rollback operations here
    op.drop_column('table_name', 'new_column')
```

### Best Practices

1. **Always test migrations locally first**
   ```bash
   docker compose up -d db
   cd backend && alembic upgrade head
   ```

2. **Make migrations reversible** - always implement `downgrade()`

3. **One logical change per migration** - easier to review and rollback

4. **Use descriptive names** - `add_user_email_column` not `update_users`

5. **Test downgrade path** - verify rollback works before merging

---

## Workflow

### Local Development

```bash
# 1) Start database
docker compose up -d db

# 2) Create migration
cd backend
alembic revision -m "your_migration_name"

# 3) Edit the generated migration file in alembic/versions/

# 4) Apply migration
alembic upgrade head

# 5) Test your changes

# 6) Test rollback
alembic downgrade -1
alembic upgrade head
```

### CI/CD Integration

Migrations should be applied automatically in the deployment pipeline:

```bash
# In deployment script
cd backend && alembic upgrade head
```

---

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current state
alembic current

# Apply pending migrations
alembic upgrade head
```

### "Can't locate revision"

```bash
# Show full history
alembic history --verbose

# Stamp database to specific revision (dangerous!)
alembic stamp <revision_id>
```

### "Connection refused"

Ensure PostgreSQL is running:

```bash
docker compose up -d db
docker compose exec db pg_isready -U postgres -d rag
```

### Schema vs Init SQL

**Note:** `infra/postgres/init.sql` only enables the pgvector extension. The full schema is applied via Alembic migrations (`backend/alembic/`), including the initial tables and indexes.

---

## Initial Schema

The initial schema is defined by Alembic migrations in `backend/alembic/versions/` and includes:

- `documents` table (with soft delete via `deleted_at`)
- `chunks` table with pgvector embeddings (768 dimensions)
- Vector similarity index (`ivfflat` cosine)

See [doc/data/postgres-schema.md](../data/postgres-schema.md) for full schema documentation.
