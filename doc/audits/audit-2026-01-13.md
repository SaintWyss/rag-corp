# AuditorÃ­a Completa RAG Corp (HISTORICAL)

> HISTORICAL: este reporte incluye versiones de herramientas (ej. `@v4`) sin relacion con el versionado del producto.

**Fecha:** 2026-01-13  
**Autor:** AuditorÃ­a automatizada  
**VersiÃ³n del repo:** main

---

## 1. Resumen de Arquitectura

### 1.1 Componentes Principales

| Componente | TecnologÃ­a | UbicaciÃ³n | Responsabilidad |
|------------|------------|-----------|-----------------|
| **Backend** | FastAPI + Python 3.11 | `backend/` | API REST, orquestaciÃ³n RAG |
| **Frontend** | Next.js 16 + TypeScript | `frontend/` | UI de chat y bÃºsqueda |
| **Base de Datos** | PostgreSQL 16 + pgvector 0.8.1 | `infra/postgres/` | Almacenamiento vectorial |
| **Contracts** | OpenAPI 3.1 + Orval | `shared/contracts/` | Tipado compartido |
| **AI Services** | Google Gemini API | Externo | Embeddings (768D) + LLM |

### 1.2 Flujo de Datos Principal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FLUJO DE INGESTA                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Cliente â†’ POST /v1/ingest/text â†’ IngestDocumentUseCase             â”‚
â”‚     1. ValidaciÃ³n (Pydantic)                                        â”‚
â”‚     2. Chunking (SimpleTextChunker: 900 chars, 120 overlap)         â”‚
â”‚     3. Embedding batch (GoogleEmbeddingService â†’ 768D vectors)      â”‚
â”‚     4. Persist atÃ³mico (PostgresDocumentRepository)                 â”‚
â”‚  Respuesta: { document_id, chunks_created }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FLUJO DE CONSULTA                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Usuario â†’ POST /v1/ask â†’ AnswerQueryUseCase                        â”‚
â”‚     1. Embed query (GoogleEmbeddingService, task_type=retrieval)    â”‚
â”‚     2. Retrieval (pgvector cosine similarity, top-k chunks)         â”‚
â”‚     3. Context building (ContextBuilder + metadata grounding)       â”‚
â”‚     4. LLM generation (Gemini 1.5 Flash + prompt versionado)        â”‚
â”‚  Respuesta: { answer, sources[] }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 PatrÃ³n ArquitectÃ³nico

**Clean Architecture** con 4 capas bien definidas:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (main.py, routes.py)       â”‚  â† HTTP, validaciÃ³n, serializaciÃ³n
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application (use_cases/)             â”‚  â† OrquestaciÃ³n, lÃ³gica de negocio
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Domain (entities.py, protocols)      â”‚  â† Entidades, interfaces (puros)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Infrastructure (services/, repos/)   â”‚  â† Implementaciones concretas
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Mapa de Carpetas

### Backend (`backend/`)

| Carpeta/Archivo | Rol | Por quÃ© existe |
|-----------------|-----|----------------|
| `app/main.py` | Entry point FastAPI | Configura app, middleware, lifespan |
| `app/routes.py` | Controllers HTTP | Define endpoints `/v1/*` |
| `app/config.py` | Settings tipados | Centraliza env vars con validaciÃ³n |
| `app/container.py` | DI Container | Composition root (wiring) |
| `app/domain/entities.py` | Entidades de dominio | `Document`, `Chunk`, `QueryResult` |
| `app/domain/repositories.py` | Protocols repos | Interfaz `DocumentRepository` |
| `app/domain/services.py` | Protocols services | `EmbeddingService`, `LLMService` |
| `app/application/use_cases/` | Casos de uso | `AnswerQuery`, `Ingest`, `Search` |
| `app/application/context_builder.py` | Context assembly | Arma contexto con metadata para LLM |
| `app/infrastructure/repositories/` | Impl repos | `PostgresDocumentRepository` |
| `app/infrastructure/services/` | Impl services | `GoogleEmbedding`, `GoogleLLM` |
| `app/infrastructure/text/` | Chunking | `SimpleTextChunker` |
| `app/infrastructure/prompts/` | Prompt templates | Versioned prompts (v1, v2) |
| `app/infrastructure/db/` | Pool management | `psycopg` connection pool |
| `app/auth.py` | API Key auth | ValidaciÃ³n de keys + scopes |
| `app/rbac.py` | RBAC | Roles y permisos granulares |
| `app/rate_limit.py` | Rate limiting | Token bucket algorithm |
| `app/security.py` | Security headers | OWASP headers middleware |
| `app/metrics.py` | Prometheus | MÃ©tricas de latencia y conteo |
| `app/logger.py` | Structured logging | JSON logs con context |
| `app/exceptions.py` | Domain exceptions | `RAGError`, `DatabaseError`, etc. |
| `tests/unit/` | Tests unitarios | Mocks, sin deps externas |
| `tests/integration/` | Tests integraciÃ³n | Requieren DB/API |

### Frontend (`frontend/`)

| Carpeta/Archivo | Rol | Por quÃ© existe |
|-----------------|-----|----------------|
| `app/page.tsx` | Home page | Componente principal UI |
| `app/hooks/useRagAsk.ts` | Custom hook | Estado y API call para RAG |
| `app/components/` | UI components | `QueryForm`, `AnswerCard`, etc. |
| `__tests__/` | Tests frontend | Jest + React Testing Library |

### Infraestructura (`infra/`)

| Carpeta | Rol | Por quÃ© existe |
|---------|-----|----------------|
| `postgres/init.sql` | Schema DDL | Crea tablas + Ã­ndice IVFFlat |
| `k8s/` | K8s manifests | Deployment, HPA, Ingress, PDB |
| `grafana/` | Dashboards | VisualizaciÃ³n mÃ©tricas |
| `prometheus/` | Scrape config | ConfiguraciÃ³n Prometheus |

### DocumentaciÃ³n (`doc/`)

| Carpeta | Rol | Por quÃ© existe |
|---------|-----|----------------|
| `architecture/overview.md` | Arquitectura | Diagrama y capas |
| `api/http-api.md` | API docs | Endpoints y ejemplos |
| `api/rbac.md` | RBAC docs | Roles y permisos |
| `data/postgres-schema.md` | Schema docs | Tablas e Ã­ndices |
| `runbook/local-dev.md` | Dev guide | Setup local |
| `runbook/kubernetes.md` | K8s guide | Deploy a K8s |
| `hitos/` | Milestone logs | Registro de cambios por hito |

### Otros

| Carpeta/Archivo | Rol |
|-----------------|-----|
| `shared/contracts/` | OpenAPI + generated TS client |
| `tests/e2e/` | Playwright E2E tests |
| `tests/load/` | Load testing (K6?) |
| `compose.yaml` | Docker Compose local |
| `compose.prod.yaml` | Compose producciÃ³n |
| `compose.observability.yaml` | Stack observability |

---

## 3. EvaluaciÃ³n de Buenas PrÃ¡cticas

### 3.1 SeparaciÃ³n de Capas âœ…

**Estado: EXCELENTE**

- **Domain layer** (`domain/`) completamente puro (dataclasses, Protocol)
- **Application layer** (`use_cases/`) solo orquesta, no conoce HTTP ni DB
- **Infrastructure** implementa interfaces sin contaminar el dominio
- **API layer** solo maneja HTTP/serializaciÃ³n

**Evidencia:**
- [entities.py](backend/app/domain/entities.py): Sin imports de FastAPI/psycopg
- [answer_query.py](backend/app/application/use_cases/answer_query.py): Usa Protocol, no impl concreta

### 3.2 Naming âœ…

**Estado: MUY BUENO**

- Clases: `PascalCase` (`IngestDocumentUseCase`, `PostgresDocumentRepository`)
- Funciones: `snake_case` (`find_similar_chunks`, `embed_query`)
- Archivos: `snake_case` (`postgres_document_repo.py`)
- DTOs claros: `AnswerQueryInput`, `IngestDocumentOutput`

**Mejora menor:** Algunos archivos usan `_req`/`_res` en vez de `Input`/`Output`

### 3.3 Manejo de Errores âœ…

**Estado: MUY BUENO**

- Excepciones tipadas: `RAGError`, `DatabaseError`, `EmbeddingError`, `LLMError`
- Structured error responses con `error_id` para correlaciÃ³n
- Exception handlers centralizados en [exception_handlers.py](backend/app/exception_handlers.py)
- Never log raw API keys (hash en logs)

**Evidencia:**
- [exceptions.py](backend/app/exceptions.py): Hierarchy clara
- HTTP 503 para service errors, 500 para generic

### 3.4 Tipado/Contratos âœ…

**Estado: EXCELENTE**

- Pydantic models para request/response
- Python `Protocol` para interfaces (duck typing)
- OpenAPI como source of truth ([openapi.json](shared/contracts/openapi.json))
- Cliente TS generado con Orval â†’ [generated.ts](shared/contracts/src/generated.ts)

### 3.5 ConfiguraciÃ³n âœ…

**Estado: MUY BUENO**

- Centralizada en [config.py](backend/app/config.py) con `pydantic-settings`
- ValidaciÃ³n de env vars al startup (fail-fast)
- Defaults sensatos documentados
- [.env.example](.env.example) completo (139 lÃ­neas)

### 3.6 Logging/Observabilidad âœ…

**Estado: MUY BUENO**

- JSON structured logging en [logger.py](backend/app/logger.py)
- Request context propagation (`request_id`, `trace_id`)
- Prometheus metrics en [metrics.py](backend/app/metrics.py)
- Stage timings (`embed_ms`, `retrieve_ms`, `llm_ms`)
- Health check en `/healthz` con verificaciÃ³n de DB y Google API

### 3.7 Seguridad âœ…

**Estado: MUY BUENO**

- API Key auth con scopes ([auth.py](backend/app/auth.py))
- RBAC con roles jerÃ¡rquicos ([rbac.py](backend/app/rbac.py))
- Constant-time comparison (previene timing attacks)
- Security headers OWASP ([security.py](backend/app/security.py))
- Rate limiting token bucket ([rate_limit.py](backend/app/rate_limit.py))
- Body size limit middleware
- CORS configurable

**Mejora:** RBAC_CONFIG aÃºn no se usa en endpoints (solo definido)

### 3.8 Tests âš ï¸

**Estado: BUENO (con gaps)**

- Estructura correcta: `unit/` y `integration/`
- Fixtures bien diseÃ±adas en [conftest.py](backend/tests/conftest.py)
- Mocks para todas las deps externas
- **20+ tests unitarios** en `tests/unit/`

**Gaps identificados:**
- Tests de frontend limitados (solo 2 archivos en `__tests__/`)
- E2E setup pero sin tests visibles en `tests/e2e/tests/`
- Load tests vacÃ­os (`tests/load/`)
- No hay coverage report actual en CI

---

## 4. Deuda TÃ©cnica Priorizada (Top 10)

### ğŸ”´ ALTA PRIORIDAD

| # | Issue | Impacto | Evidencia |
|---|-------|---------|-----------|
| 1 | **No hay CI/CD configurado** | Riesgo de regressions, deploys manuales | Falta `.github/workflows/` |
| 2 | **RBAC definido pero no integrado** | Feature incompleta, seguridad parcial | [rbac.py](backend/app/rbac.py) define roles pero `routes.py` usa solo `require_scope` |
| 3 | **Rate limit in-memory** | Se pierde al restart, no escala horizontalmente | [rate_limit.py#L27](backend/app/rate_limit.py#L27): "_In-memory storage_" |
| 4 | **Tests de frontend mÃ­nimos** | Riesgo de bugs en UI | Solo 2 archivos en `frontend/__tests__/` |

### ğŸŸ¡ MEDIA PRIORIDAD

| # | Issue | Impacto | Evidencia |
|---|-------|---------|-----------|
| 5 | **Sin soft-delete real** | `deleted_at` en entity pero no usado | [entities.py#L49](backend/app/domain/entities.py#L49): campo definido, sin impl |
| 6 | **Chunking solo simple** | Chunks pueden cortar mid-sentence | [SimpleTextChunker](backend/app/infrastructure/text/) no usa semantic boundaries |
| 7 | **No hay cache de embeddings en prod** | API calls repetidas innecesarias | `REDIS_URL` opcional, no obligatorio |
| 8 | **Pool DB no tiene retry** | Falla en transient errors de conexiÃ³n | [postgres_document_repo.py](backend/app/infrastructure/repositories/postgres_document_repo.py) no retry pool errors |

### ğŸŸ¢ BAJA PRIORIDAD

| # | Issue | Impacto | Evidencia |
|---|-------|---------|-----------|
| 9 | **Load tests vacÃ­os** | No hay baseline de performance | `tests/load/` existe pero vacÃ­o |
| 10 | **Docs desactualizadas** | Onboarding mÃ¡s lento | Algunos archivos en `_legacy_candidates/` |

---

## 5. Quick Wins (1-2 horas)

### 5.1 Agregar GitHub Actions bÃ¡sico
**Tiempo:** 1 hora  
**Impacto:** ValidaciÃ³n automÃ¡tica en PRs

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install -r backend/requirements.txt
      - run: cd backend && pytest -m unit --cov=app
```

### 5.2 Agregar test coverage badge
**Tiempo:** 30 min  
**Impacto:** Visibilidad de calidad

```bash
# En backend/
pytest --cov=app --cov-report=xml
# Subir coverage.xml a Codecov/Coveralls
```

### 5.3 Limpiar `_legacy_candidates/`
**Tiempo:** 30 min  
**Impacto:** Repo mÃ¡s limpio

- Mover docs Ãºtiles a `doc/`
- Eliminar o archivar el resto

### 5.4 Documentar variables requeridas en README
**Tiempo:** 20 min  
**Impacto:** Mejor DX

Agregar tabla con variables crÃ­ticas y sus valores por defecto.

---

## 6. Mejoras Medianas (1-2 dÃ­as)

### 6.1 Integrar RBAC en endpoints
**Tiempo:** 1 dÃ­a  
**Archivo:** [routes.py](backend/app/routes.py)

Reemplazar `require_scope` por `require_permission`:
```python
# Antes
_auth: None = Depends(require_scope("ingest"))

# DespuÃ©s
_auth: None = Depends(require_permission(Permission.DOCUMENTS_CREATE))
```

### 6.2 Migrar rate limit a Redis
**Tiempo:** 1 dÃ­a  
**Archivos:** [rate_limit.py](backend/app/rate_limit.py), [compose.yaml](compose.yaml)

- Usar Redis como backend para rate limit
- Permite escalado horizontal

### 6.3 Agregar semantic chunking
**Tiempo:** 1-2 dÃ­as  
**Archivo:** [SimpleTextChunker](backend/app/infrastructure/text/)

- Detectar sentence boundaries
- Opcional: usar LLM para mejor splitting

### 6.4 Suite E2E con Playwright
**Tiempo:** 1 dÃ­a  
**Carpeta:** `tests/e2e/`

- Agregar 5-10 tests crÃ­ticos: login, ingest, ask
- Integrar en CI

### 6.5 Dashboard Grafana de RAG
**Tiempo:** 1 dÃ­a  
**Carpeta:** `infra/grafana/dashboards/`

- Latencias por stage (embed, retrieve, llm)
- Requests por endpoint
- Error rate

---

## 7. Checklist para Correr Local

ExtraÃ­do de [README.md](README.md) y [runbook/local-dev.md](doc/runbook/local-dev.md):

### Requisitos
- [ ] Docker + Docker Compose instalado
- [ ] Node.js 20.9+ y pnpm 10+
- [ ] Cuenta Google Cloud con Gemini API habilitada

### Setup

```bash
# 1. Clonar repo
git clone <repo-url> && cd rag-corp

# 2. Configurar entorno
cp .env.example .env
# Editar .env y setear GOOGLE_API_KEY

# 3. Instalar dependencias
pnpm install

# 4. Levantar DB + Backend
pnpm docker:up
# Esperar ~30s

# 5. Verificar servicios
docker compose ps
# db y rag-api deben estar "healthy"

# 6. Generar contratos (opcional, si cambiÃ³ API)
pnpm contracts:export
pnpm contracts:gen

# 7. Levantar frontend (dev mode)
pnpm dev
```

### VerificaciÃ³n

```bash
# Health check
curl http://localhost:8000/healthz
# â†’ {"ok":true,"db":"connected","request_id":"..."}

# MÃ©tricas
curl http://localhost:8000/metrics | head -5

# Test ingesta
curl -X POST http://localhost:8000/v1/ingest/text \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","text":"RAG Corp es un sistema de bÃºsqueda semÃ¡ntica."}'

# Test query
curl -X POST http://localhost:8000/v1/ask \
  -H "Content-Type: application/json" \
  -d '{"query":"Â¿QuÃ© es RAG Corp?","top_k":3}'
```

### URLs

| Servicio | URL |
|----------|-----|
| Frontend | http://localhost:3000 |
| Backend API | http://localhost:8000 |
| API Docs (Swagger) | http://localhost:8000/docs |
| MÃ©tricas | http://localhost:8000/metrics |

### Comandos Ãštiles

```bash
# Solo DB
docker compose up -d db

# Reset completo (borra datos)
docker compose down -v

# Conectar a Postgres
docker compose exec db psql -U postgres -d rag

# Tests unitarios backend
cd backend && pytest -m unit

# Tests integraciÃ³n (requiere DB)
RUN_INTEGRATION=1 pytest -m integration

# Observability stack
pnpm docker:observability
# â†’ Prometheus: http://localhost:9090
# â†’ Grafana: http://localhost:3001 (admin/admin)
```

---

## 8. Conclusiones

### Fortalezas ğŸ’ª
1. **Arquitectura limpia** - Clean Architecture bien aplicada
2. **Seguridad** - Auth, RBAC, rate limiting, security headers
3. **Observabilidad** - Logs estructurados, mÃ©tricas Prometheus
4. **Contratos tipados** - OpenAPI â†’ TypeScript
5. **DocumentaciÃ³n** - README, runbooks, architecture docs

### Ãreas de Mejora ğŸ”§
1. **CI/CD** - No hay automatizaciÃ³n
2. **Tests** - Coverage insuficiente en frontend y E2E
3. **RBAC** - Definido pero no integrado
4. **Escalabilidad** - Rate limit in-memory

### RecomendaciÃ³n

El repo estÃ¡ en **buen estado** para un proyecto en desarrollo activo. Priorizar:
1. CI/CD bÃ¡sico (quick win con alto impacto)
2. Aumentar coverage de tests
3. Integrar RBAC en endpoints

---

*AuditorÃ­a generada automÃ¡ticamente. Verificar manualmente cualquier afirmaciÃ³n crÃ­tica.*
