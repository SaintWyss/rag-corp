%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#326ce5', 'primaryTextColor': '#fff'}}}%%
graph TB
    subgraph "Frontend (Next.js 16)"
        UI[UI Components]
        Hooks[Hooks + Pages]
        Client[API Client<br/>Orval Generated]
    end

    subgraph "Backend (FastAPI)"
        subgraph "API Layer"
            Routes[routes.py]
            AuthRoutes[auth_routes.py]
            DualAuth[dual_auth.py]
            Errors[error_responses.py]
        end

        subgraph "Application Layer"
            UC_Ask[AnswerQueryUseCase]
            UC_Ingest[IngestDocumentUseCase]
            UC_Search[SearchChunksUseCase]
            UC_List[ListDocumentsUseCase]
            UC_Process[ProcessUploadedDocumentUseCase]
            CtxBuilder[context_builder.py]
        end

        subgraph "Domain Layer"
            Entities[entities.py]
            RepoProto[repositories.py<br/>Protocols]
            SvcProto[services.py<br/>Protocols]
        end

        subgraph "Infrastructure Layer"
            PgRepo[PostgresDocumentRepo]
            AuditRepo[PostgresAuditEventRepo]
            EmbSvc[GoogleEmbeddingService]
            LLMSvc[GoogleLLMService]
            Extractor[DocumentTextExtractor]
            Chunker[SimpleTextChunker]
            Storage[S3FileStorageAdapter]
            Queue[RQDocumentProcessingQueue]
            Retry[retry.py]
        end
    end

    subgraph "Worker (RQ)"
        Job[process_document_job]
    end

    subgraph "External Services"
        PG[(PostgreSQL + pgvector)]
        Redis[(Redis)]
        S3[(S3/MinIO)]
        Gemini[Google Gemini API]
    end

    UI --> Hooks
    Hooks --> Client
    Client -->|HTTP| Routes
    Client -->|HTTP| AuthRoutes
    Routes --> DualAuth
    Routes --> UC_Ask
    Routes --> UC_Ingest
    Routes --> UC_Search
    Routes --> UC_List
    UC_Ask --> CtxBuilder
    UC_Ask --> RepoProto
    UC_Ask --> SvcProto
    UC_Ingest --> RepoProto
    UC_Ingest --> SvcProto
    UC_Search --> RepoProto
    UC_Search --> SvcProto
    UC_List --> RepoProto
    RepoProto -.->|implements| PgRepo
    RepoProto -.->|implements| AuditRepo
    SvcProto -.->|implements| EmbSvc
    SvcProto -.->|implements| LLMSvc
    SvcProto -.->|implements| Chunker
    SvcProto -.->|implements| Extractor
    SvcProto -.->|implements| Storage
    SvcProto -.->|implements| Queue
    PgRepo --> PG
    AuditRepo --> PG
    EmbSvc --> Retry
    LLMSvc --> Retry
    Retry --> Gemini
    Storage --> S3
    Queue --> Redis
    Job --> UC_Process
    UC_Process --> RepoProto
    UC_Process --> SvcProto
