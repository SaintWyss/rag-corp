# Pattern Map - RAG Corp

**Fecha**: 2026-01-03 20:59 -0300  
**Branch base**: main @ `0e9304f`  
**Autor**: GitHub Copilot (auto-refactor execution)

---

## A) Arquitectura Actual vs Objetivo

### Arquitectura Actual (âœ… YA IMPLEMENTADA)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (FastAPI)                                        â”‚
â”‚  main.py, routes.py, auth.py, rate_limit.py, middleware.py  â”‚
â”‚  error_responses.py (RFC 7807), security.py, versioning.py  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application (Use Cases + Policies)                         â”‚
â”‚  answer_query.py, ingest_document.py, search_chunks.py      â”‚
â”‚  context_builder.py (MAX_CONTEXT policy)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Domain (Entities + Ports/Protocols)                        â”‚
â”‚  entities.py, repositories.py, services.py                  â”‚
â”‚  âœ… NO imports de FastAPI/psycopg/google                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Infrastructure (Adapters + Decorators)                     â”‚
â”‚  postgres_document_repo.py, google_*_service.py             â”‚
â”‚  retry.py (tenacity decorator), pool.py, cache.py           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Arquitectura Objetivo

**Estado: âœ… YA ALCANZADA** - La arquitectura actual cumple con Clean Architecture.

---

## B) Tabla por Carpeta

### backend/app/domain/

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | Entidades core, Ports (interfaces), Value Objects |
| **Smells** | âœ… NINGUNO - Limpio, sin imports externos |
| **Patrones implementados** | Port/Adapter (Protocol), Entity |
| **Archivos** | `entities.py`, `repositories.py`, `services.py` |
| **Riesgo** | NONE |
| **Tests** | `tests/unit/test_domain_entities.py` âœ… |

### backend/app/application/

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | OrquestaciÃ³n de flujos, policies |
| **Smells** | âœ… NINGUNO - No importa FastAPI/psycopg |
| **Patrones implementados** | Use Case, Policy (context limits) |
| **Archivos** | `use_cases/answer_query.py`, `context_builder.py` |
| **Riesgo** | NONE |
| **Tests** | `tests/unit/test_answer_query_use_case.py` âœ… |

### backend/app/infrastructure/

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | Adapters para DB, APIs externas |
| **Smells** | âœ… NINGUNO - retry.py ya implementado |
| **Patrones implementados** | Adapter, Decorator (retry), Repository |
| **Archivos** | `repositories/postgres_document_repo.py`, `services/google_*.py`, `services/retry.py` |
| **Riesgo** | NONE |
| **Tests** | `tests/unit/test_retry.py` âœ… |

### backend/app/ (API layer)

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | HTTP routing, auth, rate limit, error mapping |
| **Smells** | âœ… NINGUNO - error_responses.py con RFC 7807 |
| **Patrones implementados** | Facade (error envelope), Middleware chain |
| **Archivos** | `main.py`, `routes.py`, `error_responses.py` |
| **Riesgo** | NONE |
| **Tests** | `tests/unit/test_error_responses.py`, `test_healthz.py` âœ… |

### frontend/

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | UI, hooks para API |
| **Smells** | âœ… NINGUNO - AbortController implementado |
| **Patrones implementados** | Custom Hook (Facade), Error Boundary |
| **Archivos** | `app/hooks/useRagAsk.ts`, `app/error.tsx` |
| **Riesgo** | NONE |
| **Tests** | `__tests__/hooks/useRagAsk.test.tsx` âœ… (7 tests) |

### shared/contracts/

| Aspecto | Detalle |
|---------|---------|
| **Responsibility** | Contratos tipados FEâ†”BE |
| **Smells** | âœ… NINGUNO |
| **Patrones** | Single Source of Truth (OpenAPI â†’ TypeScript) |
| **Riesgo** | NONE |

---

## C) Hallazgos (Top 10)

| # | Severidad | Estado | UbicaciÃ³n | Detalle |
|---|-----------|--------|-----------|---------|
| 1 | HIGH | âœ… FIXED | `infrastructure/services/retry.py` | Retry con tenacity |
| 2 | HIGH | âœ… FIXED | `error_responses.py` | RFC 7807 error envelope |
| 3 | MED | âœ… FIXED | `config.py` | Pydantic Settings centralizado |
| 4 | MED | âœ… FIXED | `context_builder.py` | MAX_CONTEXT_CHARS policy |
| 5 | MED | âœ… FIXED | `useRagAsk.ts` | AbortController + timeout |
| 6 | MED | âœ… FIXED | `frontend/__tests__/` | Test suite completa |
| 7 | LOW | âœ… FIXED | `domain/*.py` | CRC docstrings |
| 8 | LOW | âœ… OK | Boundaries | domain/app NO importan infra |
| 9 | LOW | âœ… FIXED | `main.py` | Health check con Google API |
| 10 | LOW | PENDING | `doc/design/patterns.md` | DocumentaciÃ³n de patrones |

---

## D) Backlog de Hitos

| # | Hito | Estado | RazÃ³n |
|---|------|--------|-------|
| H1 | Boundaries + DIP | âœ… SKIPPED | Ya implementado correctamente |
| H2 | Error Envelope | âœ… SKIPPED | `error_responses.py` existe con RFC 7807 |
| H3 | Settings central | âœ… SKIPPED | `config.py` con Pydantic Settings |
| H4 | Retry Adapters | âœ… SKIPPED | `retry.py` con tenacity ya existe |
| H5 | Retrieval Strategy | âœ… SKIPPED | `context_builder.py` con MAX_CONTEXT |
| H6 | Repository atomic | âœ… SKIPPED | `pool.py` con transacciones |
| H7 | Frontend Facade | âœ… SKIPPED | `useRagAsk.ts` con AbortController + tests |
| H8 | Docs patterns.md | ğŸ”„ TODO | Ãšnico pendiente |

---

## ConclusiÃ³n

**El repositorio ya tiene implementados todos los patrones necesarios.** 

Los refactors fueron aplicados en commits anteriores (verificado en `doc/audit-h9-h25.md`):
- H4 (retry): commit en rama que agregÃ³ `retry.py`
- H10 (error catalog): `error_responses.py`
- H14 (cache): `cache.py`
- H8 (frontend robust): tests + AbortController

**Ãšnico pendiente**: Crear `doc/design/patterns.md` como documentaciÃ³n.

---

**Generado**: 2026-01-03 20:59 -0300
