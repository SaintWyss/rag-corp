# Auditor√≠a Completa - RAG Corp

**Fecha**: 2026-01-03 14:30 UTC  
**Branch**: `main`  
**Auditor**: GitHub Copilot  opus 4.5 3x
**Objetivo**: Entender el estado actual del proyecto

---

## 1) Resumen de Arquitectura

### Componentes Principales

| Componente | Ubicaci√≥n | Tecnolog√≠a | Responsabilidad |
|------------|-----------|------------|-----------------|
| **Frontend** | `frontend/` | Next.js 16.1.1, TypeScript, Tailwind | UI para consultas RAG |
| **Backend** | `backend/` | FastAPI, Python 3.11 | API REST + l√≥gica RAG |
| **Base de Datos** | PostgreSQL 16 + pgvector 0.8.1 | Vector DB | Almacenar documentos, chunks, embeddings |
| **Servicios Externos** | Google Gemini API | Embeddings + LLM | Generar vectores y respuestas |

### Flujo de Datos Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              INGESTA                                        ‚îÇ
‚îÇ  POST /v1/ingest/text ‚Üí Chunker ‚Üí Embeddings (768D) ‚Üí PostgreSQL           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              RETRIEVAL + GENERATION                         ‚îÇ
‚îÇ  POST /v1/ask ‚Üí Embed Query ‚Üí Search Similar (pgvector) ‚Üí Build Context    ‚îÇ
‚îÇ              ‚Üí LLM Generate ‚Üí Return Answer + Sources                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Detalle del flujo `/v1/ask`** (archivo: `backend/app/application/use_cases/answer_query.py`):

1. **Embed query** (l√≠nea 119): Genera vector 768D del texto de consulta
2. **Retrieve chunks** (l√≠nea 123): Busca top-k chunks similares con cosine distance
3. **Build context** (l√≠nea 136): `ContextBuilder` arma contexto con metadata para grounding
4. **Generate answer** (l√≠nea 148): LLM responde bas√°ndose solo en el contexto
5. **Return** (l√≠nea 190): `QueryResult` con respuesta, chunks usados y timings

### Arquitectura de Capas (Clean Architecture)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  API Layer (FastAPI)                            ‚îÇ  main.py, routes.py
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Application (Use Cases)                        ‚îÇ  answer_query.py, ingest_document.py
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Domain (Entities + Protocols)                  ‚îÇ  entities.py, repositories.py, services.py
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Infrastructure (Adapters)                      ‚îÇ  postgres_document_repo.py, google_*_service.py
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2) Mapa de Carpetas

### Ra√≠z del Proyecto

| Carpeta/Archivo | Rol | Por qu√© existe |
|-----------------|-----|----------------|
| `frontend/` | UI Next.js | Interfaz de usuario para consultas RAG |
| `backend/` | API FastAPI | L√≥gica de negocio y orquestaci√≥n RAG |
| `shared/contracts/` | Contratos tipados | Single source of truth FE‚ÜîBE (OpenAPI ‚Üí TS) |
| `infra/postgres/` | DDL de BD | Schema inicial con pgvector |
| `doc/` | Documentaci√≥n t√©cnica | Arquitectura, API, runbook, schema |
| `compose.yaml` | Orquestaci√≥n Docker | Desarrollo local (db + api) |
| `.env.example` | Template de config | Variables de entorno requeridas |

### Backend (`backend/app/`)

| Carpeta | Rol | Archivos Clave |
|---------|-----|----------------|
| `domain/` | N√∫cleo de negocio | `entities.py` (Document, Chunk, QueryResult), `repositories.py`, `services.py` |
| `application/` | Use cases | `use_cases/answer_query.py`, `use_cases/ingest_document.py`, `context_builder.py` |
| `infrastructure/repositories/` | Adapters DB | `postgres_document_repo.py` (con pool) |
| `infrastructure/services/` | Adapters externos | `google_embedding_service.py`, `google_llm_service.py` |
| `infrastructure/text/` | Utilidades texto | `chunker.py` (l√≠mites naturales) |
| `infrastructure/prompts/` | Carga de prompts | `loader.py` |
| `infrastructure/db/` | Pool de conexiones | `pool.py` (psycopg_pool) |
| `prompts/` | Templates versionados | `v1_answer_es.md` |

### Frontend (`frontend/`)

| Carpeta | Rol |
|---------|-----|
| `app/` | App Router Next.js (page.tsx = UI principal) |
| `app/components/` | Componentes React |
| `app/hooks/` | Custom hooks (useRagAsk) |

---

## 3) Evaluaci√≥n de Buenas Pr√°cticas

### ‚úÖ Fortalezas

**Separaci√≥n de Capas**
- ‚úÖ Clean Architecture correctamente implementada
- ‚úÖ Use cases aislados y testeables (`backend/app/application/use_cases/answer_query.py`)
- ‚úÖ Dependency injection expl√≠cita (`backend/app/container.py`)
- ‚úÖ Protocols en domain (no dependen de implementaci√≥n)

**Contratos y Tipado**
- ‚úÖ OpenAPI como fuente de verdad (`shared/contracts/openapi.json`)
- ‚úÖ Cliente TypeScript auto-generado con Orval
- ‚úÖ Type hints en Python (alta cobertura)
- ‚úÖ Pydantic models para validaci√≥n (`backend/app/routes.py`)

**Documentaci√≥n**
- ‚úÖ CRC Cards en c√≥digo (docstrings con Name, Responsibilities, Collaborators)
- ‚úÖ README completo con quickstart
- ‚úÖ Documentaci√≥n t√©cnica organizada (`doc/`)

**Testing**
- ‚úÖ Suite documentada (`backend/tests/README.md`)
- ‚úÖ Separaci√≥n unit/integration
- ‚úÖ Mocks para dependencias externas (`backend/tests/conftest.py`)
- ‚úÖ 99%+ cobertura en unit tests

**Observabilidad (Implementada - H3)**
- ‚úÖ Logging estructurado JSON (`backend/app/logger.py`)
- ‚úÖ Request context con `request_id` (`backend/app/context.py`, `backend/app/middleware.py`)
- ‚úÖ M√©tricas Prometheus (`backend/app/metrics.py`, endpoint `/metrics`)
- ‚úÖ Timings por etapa (embed_ms, retrieve_ms, llm_ms) (`backend/app/timing.py`)
- ‚úÖ Tracing OpenTelemetry opcional (`backend/app/tracing.py`)

**Seguridad (Implementada - H4)**
- ‚úÖ API Key auth con scopes (`backend/app/auth.py`)
- ‚úÖ Rate limiting token bucket (`backend/app/rate_limit.py`)
- ‚úÖ Body size limit (`backend/app/middleware.py`)
- ‚úÖ Secret redaction en logs (`backend/app/logger.py` - `SENSITIVE_KEYS`)
- ‚úÖ CORS configurable por env

**Performance DB (Implementada - H6)**
- ‚úÖ Connection pooling (`backend/app/infrastructure/db/pool.py`)
- ‚úÖ Atomic ingest con transacciones (`backend/app/infrastructure/repositories/postgres_document_repo.py`)
- ‚úÖ Batch insert para chunks
- ‚úÖ Statement timeout configurable

**RAG Quality (Implementada - H7)**
- ‚úÖ Chunking con l√≠mites naturales (`backend/app/infrastructure/text/chunker.py`)
- ‚úÖ Prompt versionado y externalizado (`prompts/v1_answer_es.md`)
- ‚úÖ Context assembly con metadata para grounding (`backend/app/application/context_builder.py`)
- ‚úÖ Defensa b√°sica contra prompt injection

### ‚ö†Ô∏è √Åreas de Mejora

**Configuraci√≥n**
- ‚ö†Ô∏è Muchas settings nuevas; considerar agrupar en sub-configs

**Frontend**
- ‚ùå Sin tests automatizados (no hay `__tests__/`)
- ‚ùå Sin error boundary global

**Manejo de Errores**
- ‚ö†Ô∏è No hay retry logic para servicios externos (Google API)
- ‚ö†Ô∏è Health check no verifica Google API

---

## 4) Deuda T√©cnica Priorizada (Top 10)

### üî¥ Impacto Alto

| # | Issue | Evidencia | Impacto |
|---|-------|-----------|---------|
| 1 | **No hay retry logic para APIs externas** | `backend/app/infrastructure/services/google_embedding_service.py`, `backend/app/infrastructure/services/google_llm_service.py` sin `@retry` | Fallos transitorios (429, timeout) causan errores permanentes |
| 2 | **Health check no verifica Google API** | `backend/app/main.py` l√≠nea ~170: solo verifica DB | Sistema puede reportar "healthy" sin poder generar respuestas |
| 3 | **Frontend sin tests** | No existe `frontend/__tests__/` | Regresiones no detectadas en UI |

### üü° Impacto Medio

| # | Issue | Evidencia | Impacto |
|---|-------|-----------|---------|
| 4 | **Sin cach√© de embeddings** | Queries repetidas re-generan embeddings | Latencia y costo innecesarios |
| 5 | **Documentaci√≥n de errores incompleta** | `doc/api/http-api.md` no lista todos los c√≥digos | Devs frontend deben inspeccionar c√≥digo |
| 6 | **Sin streaming de respuestas** | `backend/app/infrastructure/services/google_llm_service.py` espera respuesta completa | UX lenta en respuestas largas |

### üü¢ Impacto Bajo

| # | Issue | Evidencia | Impacto |
|---|-------|-----------|---------|
| 7 | **Sin multi-turn chat** | Use case solo maneja query individual | Limitaci√≥n de funcionalidad |
| 8 | **Sin filtros por metadata** | `backend/app/infrastructure/repositories/postgres_document_repo.py` b√∫squeda solo por embedding | Queries menos precisas |
| 9 | **Sin admin UI** | No hay CRUD visual de documentos | Gesti√≥n manual v√≠a API |
| 10 | **Sin CI/CD configurado** | No hay `.github/workflows/` | Deploys manuales |

---

## 5) Quick Wins y Mejoras Medianas

### ‚ö° Quick Wins (1-2 horas c/u)

**QW1: Agregar retry logic con tenacity**

```bash
# Instalar
pip install tenacity

# Archivos a modificar:
# - backend/app/infrastructure/services/google_embedding_service.py
# - backend/app/infrastructure/services/google_llm_service.py

# Agregar decorador:
@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=2, max=10))
def embed_query(self, text: str) -> List[float]:
    ...
```

- **Beneficio**: Resilencia ante fallos transitorios
- **Testing**: Mock que falla 2 veces y luego responde

**QW2: Health check con Google API**

```python
# backend/app/main.py - modificar /healthz
# Agregar check opcional con timeout 5s
```

- **Beneficio**: Detectar degradaci√≥n real del servicio

**QW3: Error boundary en frontend**

```tsx
// frontend/app/error.tsx
'use client'
export default function Error({error, reset}) { ... }
```

- **Beneficio**: UX graceful en errores

**QW4: Documentar cat√°logo de errores**

```markdown
# doc/api/http-api.md
## Error Codes
| Code | Meaning | Example |
| 401 | Missing API key | ... |
| 403 | Invalid key or insufficient scope | ... |
| 413 | Body too large | ... |
| 429 | Rate limited | ... |
| 503 | Service unavailable (DB/Google) | ... |
```

- **Beneficio**: Onboarding m√°s r√°pido para frontend devs

### üîß Mejoras Medianas (1-2 d√≠as c/u)

**MM1: Cach√© de embeddings de queries**

- **Archivos**: Crear `backend/app/infrastructure/cache/` con Redis o in-memory LRU
- **Beneficio**: Reducir latencia y costos
- **Pasos**:
  1. Agregar `cachetools` o `redis`
  2. Cache key = hash(query_text)
  3. TTL configurable por env

**MM2: Setup tests frontend**

```bash
cd frontend
pnpm add -D jest @testing-library/react @testing-library/jest-dom
```

- **Crear**: `jest.config.js`, `__tests__/page.test.tsx`
- **Beneficio**: Detectar regresiones en UI

**MM3: Streaming de respuestas LLM**

- **Archivos**: `backend/app/infrastructure/services/google_llm_service.py`, `backend/app/routes.py`
- **Tecnolog√≠a**: SSE (Server-Sent Events)
- **Beneficio**: UX m√°s fluida, respuestas progresivas

**MM4: CI/CD con GitHub Actions**

```yaml
# .github/workflows/ci.yml
- pytest -m unit
- pnpm contracts:gen
- docker compose config --quiet
```

- **Beneficio**: Validaci√≥n autom√°tica en PRs

---

## 6) Checklist para Correr Local

### Requisitos Previos

- ‚úÖ Node.js 20.9+ y pnpm 10+
- ‚úÖ Docker y Docker Compose
- ‚úÖ Cuenta Google Cloud con Gemini API habilitada
- ‚úÖ API Key de Google Gemini

### Paso a Paso

```bash
# 1. Clonar y configurar entorno
git clone https://github.com/SaintWyss/rag-corp.git
cd rag-corp
cp .env.example .env
# Editar .env:
# - GOOGLE_API_KEY=tu_clave
# - API_KEYS_CONFIG={"test-key": ["ingest", "ask"]}

# 2. Instalar dependencias
pnpm install

# 3. Levantar infraestructura
pnpm docker:up
# Esperar ~30s para PostgreSQL
docker compose ps  # Verificar estado

# 4. Generar contratos TypeScript
pnpm contracts:export
pnpm contracts:gen

# 5. Ejecutar en desarrollo
pnpm dev
```

### Verificaci√≥n

```bash
# Health check
curl http://localhost:8000/healthz
# Esperado: {"ok": true, "db": "connected", "request_id": "..."}

# M√©tricas
curl http://localhost:8000/metrics | head -5
# Esperado: m√©tricas Prometheus

# Ingestar documento (con API key)
curl -X POST http://localhost:8000/v1/ingest/text \
  -H "X-API-Key: test-key" \
  -H "Content-Type: application/json" \
  -d '{"title": "Test", "text": "RAG Corp es un sistema de b√∫squeda sem√°ntica."}'
# Esperado: {"document_id": "...", "chunks_created": 1}

# Consulta RAG
curl -X POST http://localhost:8000/v1/ask \
  -H "X-API-Key: test-key" \
  -H "Content-Type: application/json" \
  -d '{"query": "¬øQu√© es RAG Corp?"}'
# Esperado: {"answer": "...", "sources": [...]}
```

### URLs de Acceso

- **Frontend**: http://localhost:3000
- **API**: http://localhost:8000
- **Swagger UI**: http://localhost:8000/docs
- **M√©tricas**: http://localhost:8000/metrics

### Troubleshooting

| Error | Soluci√≥n |
|-------|----------|
| "connection refused" en DB | `docker compose restart db` |
| "GOOGLE_API_KEY not configured" | Verificar `.env`, reiniciar: `docker compose restart rag-api` |
| Frontend no conecta | Verificar proxy en `frontend/next.config.ts` |
| 401 en endpoints | Agregar header `X-API-Key` |
| 429 Too Many Requests | Esperar `Retry-After` segundos |

---

## Resumen Ejecutivo

### Estado General: ‚úÖ **Proyecto Maduro y Bien Estructurado**

**Implementado correctamente:**

- ‚úÖ Clean Architecture con capas bien definidas
- ‚úÖ Observabilidad completa (H3): logs, m√©tricas, tracing opcional
- ‚úÖ Seguridad (H4): auth, rate limiting, hardening
- ‚úÖ Performance DB (H6): pooling, atomic ingest, batch
- ‚úÖ RAG Quality (H7): chunking mejorado, prompts versionados, grounding
- ‚úÖ Documentaci√≥n actualizada y completa
- ‚úÖ Suite de tests con 99%+ cobertura

**Principales Gaps Restantes:**

1. **Resilencia**: Retry logic para servicios externos
2. **Frontend**: Tests automatizados
3. **UX**: Streaming de respuestas
4. **DevOps**: CI/CD pipeline

### Recomendaci√≥n

Priorizar **QW1 (retry logic)** y **QW2 (health check robusto)** como siguiente paso, ya que mejoran la estabilidad del sistema en producci√≥n sin cambios estructurales grandes.

---

**Generado por**: GitHub Copilot  
**Fecha**: 2026-01-03 14:30 UTC  
**Branch**: `main`
