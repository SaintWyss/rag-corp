# =============================================================================
# TARJETA CRC - infra/k8s/externalsecrets/backend-externalsecret.yaml
# =============================================================================
# Responsabilidades:
# - Definir ExternalSecret para variables sensibles del backend/worker.
# - Crear el Secret real `ragcorp-secrets` en el namespace.
#
# Colaboradores:
# - infra/k8s/backend-deployment.yaml
# - infra/k8s/secret.yaml (plantilla)
# - docs/runbook/security-rotation.md
#
# Invariantes:
# - Requiere External Secrets Operator (ESO).
# - No incluir secretos reales en git.
# =============================================================================

# REQUIERE External Secrets Operator.
# Si no usas ESO, crea el Secret manualmente (`ragcorp-secrets`).
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ragcorp-backend-external-secret
  namespace: ragcorp
  labels:
    app.kubernetes.io/name: ragcorp
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: REPLACE_ME_SECRET_STORE
    kind: ClusterSecretStore
  target:
    name: ragcorp-secrets
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: ragcorp/<tenant>/<env>/database_url
    - secretKey: GOOGLE_API_KEY
      remoteRef:
        key: ragcorp/<tenant>/<env>/google_api_key
    - secretKey: JWT_SECRET
      remoteRef:
        key: ragcorp/<tenant>/<env>/jwt_secret
    - secretKey: API_KEYS_CONFIG
      remoteRef:
        key: ragcorp/<tenant>/<env>/api_keys_config
    - secretKey: RBAC_CONFIG
      remoteRef:
        key: ragcorp/<tenant>/<env>/rbac_config
    - secretKey: REDIS_URL
      remoteRef:
        key: ragcorp/<tenant>/<env>/redis_url
    - secretKey: S3_ENDPOINT_URL
      remoteRef:
        key: ragcorp/<tenant>/<env>/s3_endpoint_url
    - secretKey: S3_BUCKET
      remoteRef:
        key: ragcorp/<tenant>/<env>/s3_bucket
    - secretKey: S3_ACCESS_KEY
      remoteRef:
        key: ragcorp/<tenant>/<env>/s3_access_key
    - secretKey: S3_SECRET_KEY
      remoteRef:
        key: ragcorp/<tenant>/<env>/s3_secret_key
    - secretKey: S3_REGION
      remoteRef:
        key: ragcorp/<tenant>/<env>/s3_region
